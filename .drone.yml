pipeline:
  ping:
    group: test
    image: mongo:3.0
    commands:
      - sleep 15
  build:
    group: test
    image: node:${NODE_VERSION}
    environment:
      - MONGO_URL=mongodb://mongo:27017
    commands:
      - export MONGO_URL=mongodb://mongo:27017
      - npm install
      - MONGO_URL=mongodb://mongo:27017 npm test
  npm_auth:
    image: robertstettner/drone-npm-auth
    secrets: [ npm_username, npm_password, npm_email ]
    when:
      branch: master
  publish:
    image: node:latest
    commands:
      - node version.js
      - npm publish
    when:
      branch: master

services:
  mongo:
    image: mongo:3.0
    command: [ --smallfiles ]

matrix:
  NODE_VERSION:
    - 7
    - 8
    - 9
